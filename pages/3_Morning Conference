import streamlit as st
import pandas as pd
import time
import os
import requests
from datetime import datetime
import gspread
from google.oauth2.service_account import Credentials

st.set_page_config(page_title="Morning Conference", page_icon="ğŸ¥", layout="wide")

# ë¡œê·¸ì¸ ì²´í¬
def require_login():
    if 'user_id' not in st.session_state or not st.session_state.user_id:
        st.warning("ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤")
        time.sleep(3)
        st.switch_page("app.py")

require_login()

# ============ Excel íŒŒì¼ ì—°ë™ ============
CASES_FILE = "conference_cases.xlsx"

@st.cache_data
def load_cases(_file_mtime: float) -> pd.DataFrame:
    """ì¼€ì´ìŠ¤ ë°ì´í„° ë¡œë“œ"""
    if os.path.exists(CASES_FILE):
        df = pd.read_excel(CASES_FILE, header=0, skiprows=[1])  # ì˜ë¬¸ í—¤ë” ì‚¬ìš©, í•œê¸€ í—¤ë” ìŠ¤í‚µ
        return df
    return pd.DataFrame(columns=[
        'case_id', 'title', 'age', 'gender', 'chief_complaint', 'onset',
        'history', 'vital_signs', 'current_status', 'question',
        'image', 'video', 'author', 'created_at', 'status'
    ])

def save_cases(df: pd.DataFrame):
    """ì¼€ì´ìŠ¤ ë°ì´í„° ì €ì¥"""
    from openpyxl import load_workbook
    from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
    
    # ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if os.path.exists(CASES_FILE):
        wb = load_workbook(CASES_FILE)
        sheet = wb.active
        # ë°ì´í„° ì˜ì—­ë§Œ ì‚­ì œ (í—¤ë” ìœ ì§€)
        for row in range(3, sheet.max_row + 1):
            for col in range(1, 16):
                sheet.cell(row=row, column=col).value = None
    else:
        from openpyxl import Workbook
        wb = Workbook()
        sheet = wb.active
        sheet.title = "cases"
        
        # í—¤ë” ì„¤ì •
        headers = ['case_id', 'title', 'age', 'gender', 'chief_complaint', 'onset',
                   'history', 'vital_signs', 'current_status', 'question',
                   'image', 'video', 'author', 'created_at', 'status']
        korean_headers = ['ì¼€ì´ìŠ¤ID', 'ì œëª©', 'ë‚˜ì´', 'ì„±ë³„', 'ì£¼ì¦ìƒ', 'ë°œë³‘ì‹œê°„',
                         'ê³¼ê±°ë ¥', 'í™œë ¥ì§•í›„', 'í˜„ì¬ìƒíƒœ', 'í† ë¡ ì§ˆë¬¸',
                         'ì´ë¯¸ì§€', 'ë™ì˜ìƒURL', 'ì‘ì„±ì', 'ì‘ì„±ì¼ì‹œ', 'ìƒíƒœ']
        
        header_font = Font(bold=True, color='FFFFFF')
        header_fill = PatternFill('solid', fgColor='4472C4')
        
        for col, (eng, kor) in enumerate(zip(headers, korean_headers), 1):
            sheet.cell(row=1, column=col, value=eng).font = header_font
            sheet.cell(row=1, column=col).fill = header_fill
            sheet.cell(row=2, column=col, value=kor).font = Font(bold=True)
    
    # ë°ì´í„° ì“°ê¸°
    thin_border = Border(
        left=Side(style='thin'), right=Side(style='thin'),
        top=Side(style='thin'), bottom=Side(style='thin')
    )
    
    for row_idx, row_data in enumerate(df.values, 3):
        for col_idx, value in enumerate(row_data, 1):
            cell = sheet.cell(row=row_idx, column=col_idx, value=value)
            cell.border = thin_border
            cell.alignment = Alignment(vertical='center', wrap_text=True)
    
    wb.save(CASES_FILE)
    st.cache_data.clear()

# ============ Google Sheets ì—°ë™ (ëŒ“ê¸€, ì•Œë¦¼) ============
def get_sheets_client():
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive"
    ]
    credentials = Credentials.from_service_account_info(
        st.secrets["gcp_service_account"],
        scopes=scopes
    )
    return gspread.authorize(credentials)

def get_comments_sheet():
    client = get_sheets_client()
    sheet_url = st.secrets["google_sheets"]["spreadsheet_url"]
    spreadsheet = client.open_by_url(sheet_url)
    try:
        return spreadsheet.worksheet("comments")
    except:
        worksheet = spreadsheet.add_worksheet(title="comments", rows=1000, cols=10)
        worksheet.append_row(["comment_id", "case_id", "author", "content", "created_at", "mention_to", "is_question_to_prof"])
        return worksheet

def get_notifications_sheet():
    client = get_sheets_client()
    sheet_url = st.secrets["google_sheets"]["spreadsheet_url"]
    spreadsheet = client.open_by_url(sheet_url)
    try:
        return spreadsheet.worksheet("notifications")
    except:
        worksheet = spreadsheet.add_worksheet(title="notifications", rows=1000, cols=10)
        worksheet.append_row(["noti_id", "from_user", "to_user", "to_phone", "case_id", "message", "created_at", "is_read", "sms_sent"])
        return worksheet

# ============ SMS ë°œì†¡ ê¸°ëŠ¥ ============
def send_sms(to_phone: str, message: str) -> bool:
    """
    SMS ë°œì†¡ í•¨ìˆ˜ (SOLAPI ì‚¬ìš©)
    Secretsì— ë‹¤ìŒ ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤:
    [solapi]
    api_key = "your_api_key"
    api_secret = "your_api_secret"
    sender = "ë°œì‹ ë²ˆí˜¸"
    """
    try:
        # SOLAPI ì„¤ì • í™•ì¸
        if "solapi" not in st.secrets:
            st.warning("SMS ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. (SOLAPI API í‚¤)")
            return False
        
        api_key = st.secrets["solapi"]["api_key"]
        api_secret = st.secrets["solapi"]["api_secret"]
        sender = st.secrets["solapi"]["sender"]
        
        # ì „í™”ë²ˆí˜¸ í¬ë§· ì •ë¦¬ (í•˜ì´í”ˆ ì œê±°)
        to_phone = to_phone.replace("-", "").replace(" ", "")
        
        # SOLAPI ë©”ì‹œì§€ ë°œì†¡
        import hashlib
        import hmac
        import base64
        import uuid
        
        date = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')
        salt = str(uuid.uuid4())
        signature = hmac.new(
            api_secret.encode('utf-8'),
            (date + salt).encode('utf-8'),
            hashlib.sha256
        ).digest()
        signature = base64.b64encode(signature).decode('utf-8')
        
        headers = {
            'Authorization': f'HMAC-SHA256 apiKey={api_key}, date={date}, salt={salt}, signature={signature}',
            'Content-Type': 'application/json'
        }
        
        data = {
            "message": {
                "to": to_phone,
                "from": sender,
                "text": message
            }
        }
        
        response = requests.post(
            'https://api.solapi.com/messages/v4/send',
            headers=headers,
            json=data,
            timeout=10
        )
        
        if response.status_code == 200:
            return True
        else:
            st.error(f"SMS ë°œì†¡ ì‹¤íŒ¨: {response.text}")
            return False
            
    except Exception as e:
        st.error(f"SMS ë°œì†¡ ì˜¤ë¥˜: {str(e)}")
        return False

# ============ ì‚¬ìš©ì/êµìˆ˜ ëª©ë¡ ============
def get_users():
    """ì‚¬ìš©ì ëª©ë¡ (ì‹¤ì œë¡œëŠ” DBì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)"""
    residents = [
        {"name": "ì „ê³µì˜ A", "phone": "010-9320-8664"},
        {"name": "ì „ê³µì˜ B", "phone": "010-1234-5678"},
        {"name": "ì „ê³µì˜ C", "phone": "010-2345-6789"},
        {"name": "ì „ê³µì˜ D", "phone": "010-3456-7890"},
        {"name": "ì „ê³µì˜ E", "phone": "010-4567-8901"},
    ]
    professors = [
        {"name": "A êµìˆ˜ë‹˜", "phone": "010-5678-9012"},
        {"name": "B êµìˆ˜ë‹˜", "phone": "010-6789-0123"},
        {"name": "C êµìˆ˜ë‹˜", "phone": "010-7890-1234"},
    ]
    return residents, professors

def get_phone_by_name(name: str) -> str:
    """ì´ë¦„ìœ¼ë¡œ ì „í™”ë²ˆí˜¸ ì°¾ê¸°"""
    residents, professors = get_users()
    all_users = residents + professors
    for user in all_users:
        if user["name"] == name:
            return user["phone"]
    return ""

# ============ ë°ì´í„° í•¨ìˆ˜ë“¤ ============
def add_case(author, title, age, gender, chief_complaint, onset, history, vital_signs, current_status, question, image="", video=""):
    """ìƒˆ ì¼€ì´ìŠ¤ ì¶”ê°€"""
    file_mtime = os.path.getmtime(CASES_FILE) if os.path.exists(CASES_FILE) else 0
    df = load_cases(file_mtime)
    
    case_id = f"CASE_{datetime.now().strftime('%Y%m%d%H%M%S')}"
    created_at = datetime.now().strftime("%Y-%m-%d %H:%M")
    
    new_row = pd.DataFrame([{
        'case_id': case_id,
        'title': title,
        'age': age,
        'gender': gender,
        'chief_complaint': chief_complaint,
        'onset': onset,
        'history': history,
        'vital_signs': vital_signs,
        'current_status': current_status,
        'question': question,
        'image': image,
        'video': video,
        'author': author,
        'created_at': created_at,
        'status': 'active'
    }])
    
    df = pd.concat([df, new_row], ignore_index=True)
    save_cases(df)
    return case_id

def add_comment(case_id, author, content, mention_to=None, is_question_to_prof=False):
    """ëŒ“ê¸€ ì¶”ê°€"""
    sheet = get_comments_sheet()
    comment_id = f"CMT_{datetime.now().strftime('%Y%m%d%H%M%S')}"
    created_at = datetime.now().strftime("%Y-%m-%d %H:%M")
    sheet.append_row([comment_id, case_id, author, content, created_at, mention_to or "", str(is_question_to_prof)])
    
    if mention_to:
        phone = get_phone_by_name(mention_to)
        add_notification(author, mention_to, phone, case_id, f"[Morning Conference] '{author}'ë‹˜ì´ ë‹µë³€ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.")
    
    return comment_id

def get_comments(case_id):
    """ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°"""
    sheet = get_comments_sheet()
    data = sheet.get_all_records()
    if data:
        df = pd.DataFrame(data)
        return df[df['case_id'] == case_id]
    return pd.DataFrame(columns=["comment_id", "case_id", "author", "content", "created_at", "mention_to", "is_question_to_prof"])

def add_notification(from_user, to_user, to_phone, case_id, message, send_sms_flag=False):
    """ì•Œë¦¼ ì¶”ê°€ ë° SMS ë°œì†¡"""
    sheet = get_notifications_sheet()
    noti_id = f"NOTI_{datetime.now().strftime('%Y%m%d%H%M%S')}"
    created_at = datetime.now().strftime("%Y-%m-%d %H:%M")
    
    sms_sent = "False"
    if send_sms_flag and to_phone:
        if send_sms(to_phone, message):
            sms_sent = "True"
    
    sheet.append_row([noti_id, from_user, to_user, to_phone, case_id, message, created_at, "False", sms_sent])

def get_notifications(user_id):
    """ì•Œë¦¼ ê°€ì ¸ì˜¤ê¸°"""
    sheet = get_notifications_sheet()
    data = sheet.get_all_records()
    if data:
        df = pd.DataFrame(data)
        return df[df['to_user'] == user_id]
    return pd.DataFrame()

def mark_notification_read(noti_id):
    """ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬"""
    sheet = get_notifications_sheet()
    try:
        cell = sheet.find(noti_id)
        sheet.update_cell(cell.row, 8, "True")
    except:
        pass

# ============ UI ì‹œì‘ ============
st.title("ğŸ¥ Morning Conference")
st.write("í™˜ì ì¼€ì´ìŠ¤ì— ëŒ€í•´ ììœ ë¡­ê²Œ í† ë¡ í•˜ê³  ì§ˆë¬¸í•  ìˆ˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤.")

# ì‚¬ì´ë“œë°” - ì•Œë¦¼
with st.sidebar:
    st.subheader("ğŸ”” ì•Œë¦¼")
    notifications = get_notifications(st.session_state.user_id)
    unread = notifications[notifications['is_read'] == 'False'] if not notifications.empty else pd.DataFrame()
    
    if not unread.empty:
        st.warning(f"ì½ì§€ ì•Šì€ ì•Œë¦¼ {len(unread)}ê°œ")
        for _, noti in unread.iterrows():
            with st.expander(f"ğŸ“© {noti['from_user']}"):
                st.write(noti['message'])
                st.caption(noti['created_at'])
                if st.button("ì½ìŒ ì²˜ë¦¬", key=f"read_{noti['noti_id']}"):
                    mark_notification_read(noti['noti_id'])
                    st.rerun()
    else:
        st.info("ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.")

# íƒ­ êµ¬ì„±
tab1, tab2, tab3 = st.tabs(["ğŸ“‹ ì¼€ì´ìŠ¤ ëª©ë¡", "â• ìƒˆ ì¼€ì´ìŠ¤ ë“±ë¡", "ğŸ“¤ Push ì•Œë¦¼"])

# íƒ­ 1: ì¼€ì´ìŠ¤ ëª©ë¡ ë° í† ë¡ 
with tab1:
    file_mtime = os.path.getmtime(CASES_FILE) if os.path.exists(CASES_FILE) else 0
    cases = load_cases(file_mtime)
    
    if cases.empty:
        st.info("ë“±ë¡ëœ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì¼€ì´ìŠ¤ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.")
    else:
        for idx, case in cases.iterrows():
            with st.expander(f"ğŸ“ {case['title']} - {case['author']} ({case['created_at']})"):
                # ì¼€ì´ìŠ¤ ì •ë³´
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.markdown(f"**ë‚˜ì´/ì„±ë³„:** {case['age']}ì„¸ {case['gender']}")
                    st.markdown(f"**ì£¼ì¦ìƒ:** {case['chief_complaint']}")
                with col2:
                    st.markdown(f"**ë°œë³‘ì‹œê°„:** {case['onset']}")
                    st.markdown(f"**ê³¼ê±°ë ¥:** {case['history']}")
                with col3:
                    st.markdown(f"**í™œë ¥ì§•í›„:** {case['vital_signs']}")
                    st.markdown(f"**í˜„ì¬ìƒíƒœ:** {case['current_status']}")
                
                st.divider()
                st.markdown(f"**â“ í† ë¡  ì§ˆë¬¸:** {case['question']}")
                
                # ì´ë¯¸ì§€/ë™ì˜ìƒ í‘œì‹œ
                if pd.notna(case.get('image')) and str(case['image']).strip():
                    st.image(f"image/{case['image']}", width=400)
                
                if pd.notna(case.get('video')) and str(case['video']).strip():
                    st.video(case['video'])
                
                st.divider()
                
                # ëŒ“ê¸€ í‘œì‹œ
                st.markdown("**ğŸ’¬ í† ë¡ :**")
                comments = get_comments(case['case_id'])
                
                if not comments.empty:
                    for _, comment in comments.iterrows():
                        col1, col2 = st.columns([1, 10])
                        with col1:
                            if comment['is_question_to_prof'] == 'True':
                                st.markdown("ğŸ“")
                            else:
                                st.markdown("ğŸ‘¤")
                        with col2:
                            mention_text = f" â†’ **@{comment['mention_to']}**" if comment['mention_to'] else ""
                            st.markdown(f"**{comment['author']}**{mention_text}")
                            st.write(comment['content'])
                            st.caption(comment['created_at'])
                        st.markdown("---")
                
                # ìƒˆ ëŒ“ê¸€ ì‘ì„±
                st.markdown("**âœï¸ ë‹µë³€ ì‘ì„±:**")
                
                residents, professors = get_users()
                resident_names = [r['name'] for r in residents]
                professor_names = [p['name'] for p in professors]
                
                col1, col2 = st.columns(2)
                with col1:
                    mention_resident = st.selectbox(
                        "â™  ì „ê³µì˜ì—ê²Œ ë‹µë³€ ìš”ì²­",
                        ["ì„ íƒ ì•ˆ í•¨"] + resident_names,
                        key=f"mention_res_{case['case_id']}"
                    )
                with col2:
                    mention_prof = st.selectbox(
                        "â–  êµìˆ˜ë‹˜ì—ê²Œ ì§ˆë¬¸í•˜ê¸°",
                        ["ì„ íƒ ì•ˆ í•¨"] + professor_names,
                        key=f"mention_prof_{case['case_id']}"
                    )
                
                new_comment = st.text_area(
                    "ë‹µë³€ ë‚´ìš©",
                    key=f"comment_{case['case_id']}",
                    placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                )
                
                if st.button("ë‹µë³€ ë“±ë¡", key=f"submit_{case['case_id']}", type="primary"):
                    if new_comment.strip():
                        mention_to = None
                        is_prof_question = False
                        
                        if mention_resident != "ì„ íƒ ì•ˆ í•¨":
                            mention_to = mention_resident
                        elif mention_prof != "ì„ íƒ ì•ˆ í•¨":
                            mention_to = mention_prof
                            is_prof_question = True
                        
                        add_comment(
                            case['case_id'],
                            st.session_state.user_id,
                            new_comment,
                            mention_to,
                            is_prof_question
                        )
                        st.success("ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
                        st.rerun()
                    else:
                        st.warning("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# íƒ­ 2: ìƒˆ ì¼€ì´ìŠ¤ ë“±ë¡
with tab2:
    st.subheader("ìƒˆ ì¼€ì´ìŠ¤ ë“±ë¡")
    
    case_title = st.text_input("ì¼€ì´ìŠ¤ ì œëª©", placeholder="ì˜ˆ: 72ì„¸ ë‚¨ì„± ê¸‰ì„± ë‡Œê²½ìƒ‰ ì˜ì‹¬")
    
    col1, col2 = st.columns(2)
    with col1:
        age = st.number_input("ë‚˜ì´", min_value=0, max_value=150, value=65)
        chief_complaint = st.text_input("ì£¼ì¦ìƒ", placeholder="ì˜ˆ: ìš°ì¸¡ ìƒí•˜ì§€ ìœ„ì•½ê°")
        history = st.text_input("ê³¼ê±°ë ¥", placeholder="ì˜ˆ: ê³ í˜ˆì••, ë‹¹ë‡¨")
        current_status = st.text_input("í˜„ì¬ ìƒíƒœ", placeholder="ì˜ˆ: NIHSS 8ì , ì˜ì‹ ëª…ë£Œ")
    with col2:
        gender = st.selectbox("ì„±ë³„", ["ë‚¨", "ì—¬"])
        onset = st.text_input("ë°œë³‘ ì‹œê°„", placeholder="ì˜ˆ: ë‚´ì› 2ì‹œê°„ ì „")
        vital_signs = st.text_input("í™œë ¥ì§•í›„", placeholder="ì˜ˆ: BP 180/100, HR 88")
        image_file = st.text_input("ì´ë¯¸ì§€ íŒŒì¼ëª…", placeholder="ì˜ˆ: case001.png (image í´ë”)")
    
    video_url = st.text_input("ë™ì˜ìƒ URL (ì„ íƒ)", placeholder="ì˜ˆ: https://www.youtube.com/watch?v=...")
    
    case_question = st.text_area(
        "í† ë¡  ì§ˆë¬¸",
        height=100,
        placeholder="ì˜ˆ: í˜„ì¬ í•´ì•¼ í•  ì²˜ì¹˜ì™€ ì…ì›í•´ì„œ ì–´ë–¤ ê²€ì‚¬ë¥¼ ì¶”ê°€ë¡œ ì‹œí–‰í•´ì•¼ í• ê¹Œìš”?"
    )
    
    if st.button("ì¼€ì´ìŠ¤ ë“±ë¡", type="primary"):
        if case_title.strip() and case_question.strip():
            case_id = add_case(
                st.session_state.user_id,
                case_title, age, gender, chief_complaint, onset,
                history, vital_signs, current_status, case_question,
                image_file, video_url
            )
            st.success(f"ì¼€ì´ìŠ¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: {case_id})")
            st.balloons()
            time.sleep(1)
            st.rerun()
        else:
            st.warning("ì œëª©ê³¼ í† ë¡  ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# íƒ­ 3: Push ì•Œë¦¼ (SMS í¬í•¨)
with tab3:
    st.subheader("ğŸ“¤ Push ì•Œë¦¼ ë³´ë‚´ê¸°")
    st.write("íŠ¹ì • ì‚¬ìš©ìì—ê²Œ ì¼€ì´ìŠ¤ í† ë¡  ì°¸ì—¬ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.")
    
    residents, professors = get_users()
    all_users = [(u['name'], u['phone']) for u in residents + professors]
    user_dict = {u[0]: u[1] for u in all_users}
    
    col1, col2 = st.columns(2)
    
    with col1:
        target_user = st.selectbox("ìš”ì²­í•  ëŒ€ìƒ", list(user_dict.keys()))
        target_phone = user_dict.get(target_user, "")
        st.caption(f"ğŸ“± ì „í™”ë²ˆí˜¸: {target_phone}")
    
    with col2:
        file_mtime = os.path.getmtime(CASES_FILE) if os.path.exists(CASES_FILE) else 0
        cases = load_cases(file_mtime)
        if not cases.empty:
            case_options = {f"{row['title']} ({row['case_id']})": row['case_id'] for _, row in cases.iterrows()}
            selected_case = st.selectbox("ê´€ë ¨ ì¼€ì´ìŠ¤", list(case_options.keys()))
            selected_case_id = case_options[selected_case]
        else:
            st.warning("ë“±ë¡ëœ ì¼€ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
            selected_case_id = None
    
    push_message = st.text_area(
        "ìš”ì²­ ë©”ì‹œì§€",
        value="[Morning Conference] ì¼€ì´ìŠ¤ í† ë¡ ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”.",
        placeholder="ì˜ˆ: ì´ ì¼€ì´ìŠ¤ì— ëŒ€í•´ ì˜ê²¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤."
    )
    
    send_sms_option = st.checkbox("ğŸ“± SMSë¡œë„ ë°œì†¡", value=True)
    
    st.divider()
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("ğŸ“¤ Push ì•Œë¦¼ ë³´ë‚´ê¸°", type="primary", use_container_width=True):
            if target_user and selected_case_id and push_message.strip():
                add_notification(
                    st.session_state.user_id,
                    target_user,
                    target_phone,
                    selected_case_id,
                    push_message,
                    send_sms_flag=send_sms_option
                )
                if send_sms_option:
                    st.success(f"'{target_user}'ë‹˜ì—ê²Œ ì•Œë¦¼ê³¼ SMSë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!")
                else:
                    st.success(f"'{target_user}'ë‹˜ì—ê²Œ ì•Œë¦¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!")
            else:
                st.warning("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    
    with col2:
        # ì§ì ‘ ì „í™”ë²ˆí˜¸ ì…ë ¥í•˜ì—¬ SMS ë°œì†¡
        st.markdown("**ë˜ëŠ” ì§ì ‘ SMS ë°œì†¡:**")
    
    st.divider()
    st.markdown("### ğŸ“± ì§ì ‘ SMS ë°œì†¡")
    
    direct_phone = st.text_input("ì „í™”ë²ˆí˜¸", value="010-9320-8664", placeholder="010-1234-5678")
    direct_message = st.text_area(
        "ë©”ì‹œì§€ ë‚´ìš©",
        value="[Morning Conference] ìƒˆë¡œìš´ ì¼€ì´ìŠ¤ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.",
        key="direct_sms_message"
    )
    
    if st.button("ğŸ“± SMS ì§ì ‘ ë°œì†¡", type="secondary"):
        if direct_phone.strip() and direct_message.strip():
            if send_sms(direct_phone, direct_message):
                st.success(f"'{direct_phone}'ë¡œ SMSë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤!")
            else:
                st.error("SMS ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. SOLAPI ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        else:
            st.warning("ì „í™”ë²ˆí˜¸ì™€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# í˜ì´ì§€ í•˜ë‹¨ ì•ˆë‚´
st.divider()
st.caption("ğŸ’¡ Tip: ì‚¬ì´ë“œë°”ì—ì„œ ì•Œë¦¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. SMS ë°œì†¡ì„ ìœ„í•´ì„œëŠ” SOLAPI ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")

