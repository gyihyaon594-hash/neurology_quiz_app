import streamlit as st
import time
from datetime import datetime
import gspread
from google.oauth2.service_account import Credentials

st.set_page_config(page_title="Morning Conference", page_icon="ğŸ¥")

# ë¡œê·¸ì¸ ì²´í¬
def require_login():
    if 'user_id' not in st.session_state or not st.session_state.user_id:
        st.warning("ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤")
        time.sleep(3)
        st.switch_page("app.py")

require_login()

# Google Sheets ì—°ê²°
def get_sheets_client():
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive"
    ]
    credentials = Credentials.from_service_account_info(
        st.secrets["gcp_service_account"],
        scopes=scopes
    )
    return gspread.authorize(credentials)

def get_conference_sheet():
    client = get_sheets_client()
    sheet_url = st.secrets["google_sheets"]["spreadsheet_url"]
    spreadsheet = client.open_by_url(sheet_url)
    try:
        return spreadsheet.worksheet("conference")
    except:
        worksheet = spreadsheet.add_worksheet(title="conference", rows=1000, cols=5)
        worksheet.append_row(["id", "author", "content", "created_at", "image_name"])
        return worksheet

def add_comment(author, content, image_name=""):
    """ëŒ“ê¸€ ì¶”ê°€"""
    sheet = get_conference_sheet()
    comment_id = datetime.now().strftime('%Y%m%d%H%M%S')
    created_at = datetime.now().strftime("%Y-%m-%d %H:%M")
    sheet.append_row([comment_id, author, content, created_at, image_name])

def get_all_comments():
    """ëª¨ë“  ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°"""
    sheet = get_conference_sheet()
    data = sheet.get_all_records()
    return data

# ============ UI ============
st.title("ğŸ¥ Morning Conference")
st.write("ì‚¬ì§„ì„ ê³µìœ í•˜ê³  ììœ ë¡­ê²Œ í† ë¡ í•˜ì„¸ìš”.")

st.divider()

# ìƒˆ ê¸€ ì‘ì„±
st.subheader("âœï¸ ìƒˆ ê¸€ ì‘ì„±")

# ì´ë¯¸ì§€ ì—…ë¡œë“œ
uploaded_image = st.file_uploader("ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)", type=['png', 'jpg', 'jpeg'])

# ë‚´ìš© ì…ë ¥
new_content = st.text_area(
    "ë‚´ìš©",
    placeholder="ì§ˆë¬¸ì´ë‚˜ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”...",
    height=100
)

if st.button("ë“±ë¡", type="primary"):
    if new_content.strip():
        image_name = ""
        
        # ì´ë¯¸ì§€ ì €ì¥
        if uploaded_image:
            image_name = f"conf_{datetime.now().strftime('%Y%m%d%H%M%S')}_{uploaded_image.name}"
            with open(f"image/{image_name}", "wb") as f:
                f.write(uploaded_image.getbuffer())
        
        add_comment(st.session_state.user_id, new_content, image_name)
        st.success("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
        st.rerun()
    else:
        st.warning("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

st.divider()

# ëŒ“ê¸€ ëª©ë¡
st.subheader("ğŸ’¬ í† ë¡ ")

comments = get_all_comments()

if not comments:
    st.info("ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!")
else:
    # ìµœì‹ ìˆœ ì •ë ¬
    comments = sorted(comments, key=lambda x: x['id'], reverse=True)
    
    for comment in comments:
        with st.container():
            # ì‘ì„±ì, ì‹œê°„
            st.markdown(f"**{comment['author']}** Â· {comment['created_at']}")
            
            # ì´ë¯¸ì§€ í‘œì‹œ
            if comment['image_name']:
                try:
                    st.image(f"image/{comment['image_name']}", width=400)
                except:
                    pass
            
            # ë‚´ìš©
            st.write(comment['content'])
            
            st.divider()


